#!/bin/bash
# Retrieve information about source code in one or more Maven projects

function list() {
	dir="$1"
	shift
	find $dir -path '*/src/main/java/*' -name '*.java' "$@"
}

function count() {
	for dir in "${@}"
	do
		echo -n "$dir: "
		list "$dir" -print0 \
			| wc --files0-from - -l | tail -1 | sed -s 's/ total$//'
	done
}

function blame() {
	for dir in "${@}"
	do
		echo "$dir: "
		list "$dir" -print0 \
			| xargs -0 --no-run-if-empty -n 1 git blame -M --line-porcelain -- | sed -n 's/^author //p' | sort | uniq -c | sort -rn

	done
}


FEATURE=count

while getopts 'clb' opt
do
	case "$opt" in
		c)
			FEATURE=count
			;;
		l)
			FEATURE=list
			;;
		b)
			FEATURE=blame
			;;
		\?)
			exit 1
			;;
	esac
done

shift $(( OPTIND - 1 ))

$FEATURE "$@"

