#!/bin/bash -e
# gh-report: generate a draft report from GitHub activity (with false positives: filter them out from the output before reporting!)

ghtoken=$(cat $HOME/.github/token-readonly)

tmpfile=$(mktemp --suffix '.md')

echo 1>&2 "Will output to $tmpfile"

for filter in 'author:@me' 'involves:@me -author:@me'
do
  echo "================================================"
  echo "$filter"
  echo "------------------------------------------------"
  {
    for type in issue pr
    do
      curl --fail-with-body -s -S -G -X GET -L \
        -H "Accept: application/vnd.github+json" \
        -H "Authorization: Bearer $ghtoken" \
        -H "X-GitHub-Api-Version: 2022-11-28" \
        https://api.github.com/search/issues \
        -d 'per_page=100' -d 'sort=updated' -d 'order=asc' \
        --data-urlencode "q=is:$type $filter updated:>=$(date -I -u -d '7 days ago')"
    done
  } | jq -s -r 'if any(.incomplete_results) then "More than 100 hits!" else if .[]["items"] then map(.items) | flatten(1) | sort_by(.repository_url) | .[] | "[\(.repository_url | sub("^.*/repos/"; ""))#\(.number)](\(.html_url)) \(.title)" else . end end'
done >"$tmpfile"

xdg-open "$tmpfile"
